# æ„å»ºé˜¶æ®µ - ä½¿ç”¨ç»Ÿä¸€åŸºç¡€é•œåƒ
FROM youirpa/fullstack-base:latest AS builder

# è®¾ç½®æ„å»ºå‚æ•°
ARG NODE_ENV=production
ARG VUE_APP_API_URL
ARG VUE_APP_BASE_API

# åˆ‡æ¢åˆ° root ç”¨æˆ·
USER root

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶å‰ç«¯é¡¹ç›®æ–‡ä»¶
COPY web/package.json web/yarn.lock* ./

# å®‰è£…ä¾èµ–
RUN yarn install --frozen-lockfile --network-timeout 300000

# å¤åˆ¶æºä»£ç 
COPY web/ .

# æ„å»ºåº”ç”¨
RUN yarn build

# ç”Ÿäº§é˜¶æ®µ - ä½¿ç”¨è½»é‡çº§ Nginx é•œåƒ
FROM nginx:alpine

# è®¾ç½®æ ‡ç­¾
LABEL maintainer="youirpa-team"
LABEL version="1.0"
LABEL service="web"
LABEL description="YOUIRPA Web Application"

# å®‰è£…å¿…è¦çš„å·¥å…·
RUN apk add --no-cache curl netcat-openbsd

# åˆ›å»ºé root ç”¨æˆ·
RUN adduser -D -H -u 101 -s /sbin/nologin nginx-user

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder /app/dist /usr/share/nginx/html

# åˆ›å»º Nginx é…ç½®ç›®å½•
RUN mkdir -p /etc/nginx/conf.d

# å¤åˆ¶é»˜è®¤ Nginx é…ç½®
COPY ./docker_env/nginx/nginx_prod.conf /etc/nginx/conf.d/default.conf

# è®¾ç½®ç›®å½•æƒé™
RUN chown -R nginx-user:nginx-user /usr/share/nginx/html && \
    chmod -R 755 /usr/share/nginx/html && \
    chown -R nginx-user:nginx-user /var/cache/nginx && \
    chown -R nginx-user:nginx-user /var/log/nginx && \
    chown -R nginx-user:nginx-user /etc/nginx/conf.d && \
    touch /var/run/nginx.pid && \
    chown nginx-user:nginx-user /var/run/nginx.pid

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN echo '#!/bin/sh\n\
set -e\n\
\n\
echo "ğŸš€ å¯åŠ¨ Web æœåŠ¡..."\n\
\n\
# æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦å°±ç»ª\n\
echo "â³ ç­‰å¾…åç«¯æœåŠ¡å°±ç»ª..."\n\
while ! nc -z youirpa-django 8000; do\n\
    echo "ç­‰å¾… Django æœåŠ¡..."\n\
    sleep 2\n\
done\n\
echo "âœ… åç«¯æœåŠ¡å·²å°±ç»ª"\n\
\n\
echo "ğŸ¯ å¯åŠ¨ Nginx..."\n\
exec nginx -g "daemon off;"\n\
' > /docker-entrypoint.sh && \
    chmod +x /docker-entrypoint.sh && \
    chown nginx-user:nginx-user /docker-entrypoint.sh

# åˆ‡æ¢åˆ°é root ç”¨æˆ·
USER nginx-user

# æš´éœ²ç«¯å£
EXPOSE 8080

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8080/ || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["/docker-entrypoint.sh"]