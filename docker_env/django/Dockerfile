# ä½¿ç”¨ç»Ÿä¸€åŸºç¡€é•œåƒ
FROM youirpa/fullstack-base:latest

# åˆ‡æ¢åˆ° root ç”¨æˆ·è¿›è¡Œå®‰è£…
USER root

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /cere_pro

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV DJANGO_SETTINGS_MODULE=application.settings \
    DATABASE_HOST=youirpa-mysql \
    REDIS_HOST=youirpa-redis

# å¤åˆ¶é¡¹ç›®çš„ requirements.txt
COPY ./cere_pro/requirements.txt .

# å®‰è£…é¡¹ç›®ç‰¹å®šä¾èµ–ï¼ˆåŸºäº cere_pro/requirements.txtï¼‰
RUN pip install -i https://pypi.tuna.tsinghua.edu.cn/simple/ \
    --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY ./cere_pro/ .

# åˆ›å»ºå¿…è¦çš„ç›®å½•å¹¶è®¾ç½®æƒé™
RUN mkdir -p /var/log/django /cere_pro/media /cere_pro/static && \
    chown -R app:app /cere_pro /var/log/django && \
    chmod -R 755 /cere_pro/media /cere_pro/static

# å¤åˆ¶å¹¶é…ç½®ç¯å¢ƒæ–‡ä»¶
RUN if [ -f ./conf/env.example.py ]; then \
    cp ./conf/env.example.py ./conf/env.py && \
    sed -i "s|DATABASE_HOST = '127.0.0.1'|DATABASE_HOST = '${DATABASE_HOST}'|g" ./conf/env.py && \
    sed -i "s|REDIS_HOST = '127.0.0.1'|REDIS_HOST = '${REDIS_HOST}'|g" ./conf/env.py && \
    chown app:app ./conf/env.py; \
    fi

# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
USER app

# æ”¶é›†é™æ€æ–‡ä»¶
RUN python manage.py collectstatic --noinput || echo "é™æ€æ–‡ä»¶æ”¶é›†è·³è¿‡"

# åˆ‡æ¢å› root åˆ›å»ºå¯åŠ¨è„šæœ¬
USER root
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "ğŸš€ å¯åŠ¨ Django æœåŠ¡..."\n\
echo "ç­‰å¾…æ•°æ®åº“è¿æ¥..."\n\
while ! nc -z ${DATABASE_HOST:-mysql} 3306; do\n\
    echo "â³ ç­‰å¾… MySQL å°±ç»ª..."\n\
    sleep 2\n\
done\n\
echo "âœ… MySQL å·²å°±ç»ª"\n\
\n\
echo "ç­‰å¾… Redis è¿æ¥..."\n\
while ! nc -z ${REDIS_HOST:-redis} 6379; do\n\
    echo "â³ ç­‰å¾… Redis å°±ç»ª..."\n\
    sleep 2\n\
done\n\
echo "âœ… Redis å·²å°±ç»ª"\n\
\n\
echo "ğŸ”„ æ‰§è¡Œæ•°æ®åº“è¿ç§»..."\n\
python manage.py migrate --noinput\n\
\n\
echo "ğŸ¯ å¯åŠ¨ Django åº”ç”¨æœåŠ¡å™¨..."\n\
exec gunicorn application.wsgi:application \\\n\
    --bind 0.0.0.0:8000 \\\n\
    --workers 4 \\\n\
    --threads 2 \\\n\
    --timeout 60 \\\n\
    --keepalive 2 \\\n\
    --max-requests 1000 \\\n\
    --max-requests-jitter 50 \\\n\
    --access-logfile /var/log/django/access.log \\\n\
    --error-logfile /var/log/django/error.log \\\n\
    --log-level info\n\
' > /cere_pro/docker_start.sh && \
    chmod +x /cere_pro/docker_start.sh && \
    chown app:app /cere_pro/docker_start.sh

# è®¾ç½®å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8000/health/ || python -c "import requests; requests.get('http://localhost:8000', timeout=5)" || exit 1

# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
USER app

# è®¾ç½®å¯åŠ¨å‘½ä»¤
CMD ["/cere_pro/docker_start.sh"]

# æ·»åŠ æ ‡ç­¾
LABEL maintainer="youirpa-team" \
    version="1.0" \
    service="django" \
    description="Django application for YOUIRPA"

# æš´éœ²ç«¯å£
EXPOSE 8000